<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Sidang Biologi - Cloud Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #059669; --primary-dark: #047857; --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; --sidebar-width: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg); color: var(--text); overflow: hidden; }

        /* AUTH SCREEN */
        .auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary-dark), var(--primary)); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size: 0.9rem; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .auth-btn:hover { background: var(--primary-dark); }
        .toggle-link { margin-top: 15px; font-size: 0.85rem; color: #666; cursor: pointer; text-decoration: underline; }

        /* DASHBOARD LAYOUT */
        #dashboard-app { display: none; height: 100vh; width: 100%; }
        .sidebar { width: var(--sidebar-width); background: var(--primary-dark); color: white; padding: 20px; display: flex; flex-direction: column; height: 100%; }
        .brand { font-size: 1.2rem; font-weight: 600; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .user-info { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .menu-item { padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; transition: 0.3s; display: none; align-items: center; gap: 12px; color: rgba(255,255,255,0.9); font-size: 0.9rem; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .logout-container { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .btn-logout { width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }
        h2 { margin-bottom: 20px; color: var(--primary-dark); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; }
        .card { background: var(--white); padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; color: #374151; font-weight: 600; }
        
        .sub-table { width: 100%; background: #fefefe; border: 1px solid #eee; border-radius: 4px; }
        .sub-table td { padding: 5px 10px; border: none; font-size: 0.85rem; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .status-Pending { background: #fef3c7; color: #d97706; }
        .status-Scheduled { background: #d1fae5; color: #059669; }
        .status-Done { background: #dbeafe; color: #1e40af; }
        
        .btn-action { border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; color: white; font-size: 0.8rem; }
        .btn-edit { background: #2563eb; } 
        .btn-delete { background: #ef4444; }
        .btn-download { background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-height: 90vh; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }

        /* PDF TEMPLATE STYLING (DIUBAH AGAR LEBIH STABIL) */
        #pdf-template { position: fixed; left: 0; top: 0; width: 210mm; min-height: 297mm; background: white; color: black; font-family: 'Times New Roman', Times, serif; z-index: -100; visibility: hidden; }
        .pdf-content { padding: 0 25mm 25mm 25mm; }
        .pdf-kop { width: 100%; display: block; margin-bottom: 20px; }
        .pdf-body { font-size: 12pt; line-height: 1.6; text-align: justify; }
        .pdf-sig-container { margin-top: 40px; display: flex; justify-content: flex-end; }
        .pdf-sig-box { text-align: left; width: 250px; }
    </style>
</head>
<body>

    <div id="pdf-template">
        <img class="pdf-kop" id="img-kop" src="kop biologi.jpg" crossorigin="anonymous">
        <div class="pdf-content">
            <div class="pdf-body">
                <p>Nomor : <span id="pdf-nomor">69/N/Bio-FKIP/XII/2025</span></p>
                [cite_start]<p>Perihal : <b>Hasil Sidang Skripsi</b> [cite: 7]</p>
                <br>
                <p>Yth. Sdr. <b id="pdf-nama-mhs">NAMA MAHASISWA</b></p>
                [cite_start]<p>Peserta Sidang Skripsi [cite: 9]</p>
                [cite_start]<p>Program Studi Pendidikan Biologi [cite: 10]</p>
                [cite_start]<p>FKIP Unwir [cite: 11]</p>
                <br>
                [cite_start]<p>Berdasarkan hasil penilaian Tim Penguji atas penampilan Saudara pada Sidang Skripsi yang telah dilaksanakan, Saudara dinyatakan <b>Lulus</b> dengan nilai <b>(<span id="pdf-grade">A</span>) (<span id="pdf-skor">80.00</span>)</b> pada Program Studi Pendidikan Biologi FKIP Universitas Wiralodra[cite: 13].</p>
                <br>
                [cite_start]<p>Kami ucapkan selamat kepada Saudara yang dinyatakan lulus dan jangan berkecil hati, tetaplah bersemangat bagi Saudara yang dinyatakan tidak lulus[cite: 14].</p>
            </div>
            <div class="pdf-sig-container">
                <div class="pdf-sig-box">
                    [cite_start]<p>Indramayu, <span id="pdf-tgl-skrg"></span> [cite: 15]</p>
                    [cite_start]<p>Ketua Program Studi, [cite: 15]</p>
                    <br><br><br><br><br>
                    <p><b>Dr. [cite_start]Sugianto, M.Pd.</b> [cite: 17]</p>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="auth-container">
        <div id="login-box" class="auth-box">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-microscope"></i></div>
            <h3 style="color:var(--primary-dark); margin-bottom:20px;">Sidang Biologi Cloud</h3>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="login-user" class="auth-input" placeholder="Username / NPM" required>
                <input type="password" id="login-pass" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-btn">Masuk ke Sistem</button>
            </form>
            <div class="toggle-link" onclick="toggleAuth('register')">Mahasiswa baru? Daftar disini</div>
        </div>
        <div id="register-box" class="auth-box" style="display: none;">
            <h3>Registrasi Mahasiswa</h3>
            <form onsubmit="handleRegister(event)">
                <input type="text" id="reg-npm" class="auth-input" placeholder="NPM" required>
                <input type="text" id="reg-nama" class="auth-input" placeholder="Nama Lengkap" required>
                <input type="password" id="reg-pass" class="auth-input" placeholder="Password Baru" required>
                <button type="submit" class="auth-btn">Daftar Akun</button>
            </form>
            <div class="toggle-link" onclick="toggleAuth('login')">Sudah punya akun? Login</div>
        </div>
    </div>

    <div id="dashboard-app">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-dna"></i> Prodi Biologi</div>
            <div class="user-info">
                <div id="display-role" style="font-size:0.65rem; text-transform:uppercase; letter-spacing:1px;">ROLE</div>
                <div id="display-name" style="font-weight:600; font-size:0.95rem;">User Name</div>
            </div>
            <div class="menu-list" style="flex:1;">
                <div class="menu-item" id="menu-jadwal" onclick="showSection('jadwal')"><i class="fas fa-calendar-check"></i> Jadwal & Nilai</div>
                <div class="menu-item" id="menu-daftar" onclick="showSection('pendaftaran')"><i class="fas fa-edit"></i> Pendaftaran</div>
                <div class="menu-item" id="menu-admin" onclick="showSection('admin')"><i class="fas fa-user-shield"></i> Control Panel</div>
                <div class="menu-item" id="menu-data-dosen" onclick="showSection('data-dosen')"><i class="fas fa-users-rectangle"></i> Kelola Dosen</div>
            </div>
            <div class="logout-container">
                <button class="btn-logout" onclick="handleLogout()"><i class="fas fa-power-off"></i> Logout</button>
            </div>
        </div>

        <div class="main">
            <div id="pendaftaran" class="section">
                <h2>Form Pendaftaran Sidang</h2>
                <div class="card">
                    <form id="formDaftar">
                        <label style="font-size:0.8rem; color:#666;">Data Mahasiswa:</label>
                        <div class="auth-input" style="background:#f3f4f6; border:none; color:#444;" id="m-info">NPM - Nama</div>
                        <input type="text" id="judul" class="auth-input" placeholder="Judul Skripsi Lengkap" required>
                        <label style="font-size:0.8rem;">Dosen Pembimbing 1:</label>
                        <select id="pembimbing1" class="auth-input" required></select>
                        <label style="font-size:0.8rem;">Dosen Pembimbing 2:</label>
                        <select id="pembimbing2" class="auth-input" required></select>
                        <button type="submit" class="btn-submit">Kirim Pengajuan Sidang</button>
                    </form>
                </div>
            </div>

            <div id="jadwal" class="section">
                <h2 id="title-jadwal">Monitoring Jadwal & Nilai</h2>
                <div class="card">
                    <table id="tabelJadwal">
                        <thead><tr id="headJadwal"></tr></thead>
                        <tbody id="bodyJadwal"></tbody>
                    </table>
                </div>
            </div>

            <div id="admin" class="section">
                <h2>Admin Control Panel</h2>
                <div class="card">
                    <table>
                        <thead><tr><th>Mahasiswa</th><th>Judul Skripsi</th><th>Status Jadwal</th><th>Opsi</th></tr></thead>
                        <tbody id="bodyAdmin"></tbody>
                    </table>
                    <div style="margin-top:40px; border-top:2px dashed #eee; padding-top:20px;">
                        <button class="btn-delete" style="width:100%; padding:12px; font-weight:600;" onclick="resetSemuaData()">
                            <i class="fas fa-triangle-exclamation"></i> RESET DATABASE CLOUD
                        </button>
                    </div>
                </div>
            </div>

            <div id="data-dosen" class="section">
                <h2>Manajemen Data Dosen</h2>
                <div class="card">
                    <form onsubmit="addDosen(event)" style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:10px; margin-bottom:20px;">
                        <input type="text" id="d-nama" placeholder="Nama & Gelar" class="auth-input" required>
                        <input type="text" id="d-user" placeholder="Username" class="auth-input" required>
                        <input type="text" id="d-pass" placeholder="Password" class="auth-input" required>
                        <button class="btn-submit" style="height:45px;">Simpan</button>
                    </form>
                    <table>
                        <thead><tr><th>Nama Dosen</th><th>Username</th><th>Aksi</th></tr></thead>
                        <tbody id="bodyDosen"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalJadwal">
        <div class="modal-content">
            <h3>Atur Penjadwalan Sidang</h3>
            <hr style="margin:15px 0;">
            <input type="hidden" id="edit-id">
            <label>Tanggal Sidang:</label><input type="date" id="set-tgl" class="auth-input">
            <label>Waktu Sidang:</label><input type="time" id="set-jam" class="auth-input">
            <label>Ketua Penguji (P1):</label><select id="set-p1" class="auth-input"></select>
            <label>Anggota Penguji (P2):</label><select id="set-p2" class="auth-input"></select>
            <label>Anggota Penguji (P3):</label><select id="set-p3" class="auth-input"></select>
            <button onclick="saveJadwalCloud()" class="btn-submit">Terbitkan Jadwal Sidang</button>
            <button onclick="closeModal()" style="background:#94a3b8; margin-top:10px;" class="btn-submit">Batal</button>
        </div>
    </div>

    <div class="modal" id="modalNilai">
        <div class="modal-content">
            <h3 id="n-title">Input Nilai Sidang</h3>
            <hr style="margin:15px 0;">
            <input type="hidden" id="n-id"><input type="hidden" id="n-role">
            <label>Skor Angka (0-100):</label>
            <input type="number" id="n-skor" class="auth-input" placeholder="0-100" min="0" max="100">
            <label>Catatan Revisi:</label>
            <textarea id="n-revisi" class="auth-input" style="height:100px; padding-top:10px;"></textarea>
            <button onclick="saveNilaiCloud()" class="btn-submit">Simpan Nilai Ke Cloud</button>
            <button onclick="closeModal()" style="background:#94a3b8; margin-top:10px;" class="btn-submit">Batal</button>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAeKgtwI7Dj1Z_zEXM-4I36u7gJ8ycUEps",
            authDomain: "sidang-biologi.firebaseapp.com",
            databaseURL: "https://sidang-biologi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sidang-biologi",
            storageBucket: "sidang-biologi.firebasestorage.app",
            messagingSenderId: "192936300926",
            appId: "1:192936300926:web:a6b32847a26c26b5df232f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dbSidang = [];
        let dbDosen = [];
        let dbUsers = [];
        let currentUser = JSON.parse(sessionStorage.getItem('sess_bio_cloud'));

        db.ref('sidang').on('value', snap => {
            dbSidang = snap.val() ? Object.values(snap.val()) : [];
            renderAll();
        });

        db.ref('dosen').on('value', snap => {
            dbDosen = snap.val() ? Object.values(snap.val()) : [];
            populateDosenSelects();
            renderAll();
        });

        db.ref('users').on('value', snap => {
            dbUsers = snap.val() ? Object.values(snap.val()) : [];
        });

        function getNilaiHuruf(s) {
            if (!s || s === 0) return '-';
            if (s >= 80) return 'A'; if (s >= 75) return 'AB'; if (s >= 70) return 'B';
            if (s >= 65) return 'BC'; if (s >= 60) return 'C'; if (s >= 50) return 'D';
            return 'E';
        }

        function toggleAuth(v) {
            document.getElementById('login-box').style.display = v === 'login' ? 'block' : 'none';
            document.getElementById('register-box').style.display = v === 'register' ? 'block' : 'none';
        }

        function handleRegister(e) {
            e.preventDefault();
            const npm = document.getElementById('reg-npm').value;
            db.ref('users/' + npm).set({
                nama: document.getElementById('reg-nama').value,
                username: npm,
                password: document.getElementById('reg-pass').value,
                role: 'mahasiswa'
            });
            alert('Registrasi Mahasiswa Berhasil!');
            toggleAuth('login');
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            if(u === 'admin' && p === 'samirnawir21') {
                loginSuccess({nama: 'Super Admin', role: 'admin'}); return;
            }

            const d = dbDosen.find(x => x.username === u && x.password === p);
            if(d) { loginSuccess({...d, role: 'dosen'}); return; }

            const m = dbUsers.find(x => x.username === u && x.password === p);
            if(m) { loginSuccess({...m, role: 'mahasiswa'}); return; }

            alert('Login Gagal!');
        }

        function loginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem('sess_bio_cloud', JSON.stringify(user));
            initApp();
        }

        function handleLogout() {
            sessionStorage.removeItem('sess_bio_cloud');
            location.reload();
        }

        function initApp() {
            if(!currentUser) return;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard-app').style.display = 'flex';
            document.getElementById('display-name').innerText = currentUser.nama;
            document.getElementById('display-role').innerText = currentUser.role;

            const mItems = ['menu-jadwal', 'menu-daftar', 'menu-admin', 'menu-data-dosen'];
            mItems.forEach(i => document.getElementById(i).style.display = 'none');

            if(currentUser.role === 'admin') {
                mItems.forEach(i => document.getElementById(i).style.display = 'flex');
                showSection('admin');
            } else if(currentUser.role === 'dosen') {
                document.getElementById('menu-jadwal').style.display = 'flex';
                showSection('jadwal');
            } else {
                document.getElementById('menu-jadwal').style.display = 'flex';
                document.getElementById('menu-daftar').style.display = 'flex';
                document.getElementById('m-info').innerText = `${currentUser.username} - ${currentUser.nama}`;
                showSection('pendaftaran');
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if(document.getElementById('menu-'+id)) document.getElementById('menu-'+id).classList.add('active');
            renderAll();
        }

        function renderAll() {
            renderJadwal();
            renderAdmin();
            renderDosenList();
        }

        function renderJadwal() {
            const body = document.getElementById('bodyJadwal');
            const head = document.getElementById('headJadwal');
            body.innerHTML = '';

            if(currentUser?.role === 'dosen') {
                head.innerHTML = `<th>Mahasiswa</th><th>Waktu</th><th>Peran & Nilai Anda</th><th>Aksi</th><th>Status</th>`;
            } else {
                head.innerHTML = `<th>Mahasiswa</th><th>Waktu</th><th>Status/Nilai</th><th>Status Sidang</th>`;
            }

            let data = dbSidang;
            if(currentUser?.role === 'dosen') {
                data = dbSidang.filter(s => 
                    s.pem1 === currentUser.nama || s.pem2 === currentUser.nama ||
                    s.penguji.p1 === currentUser.nama || s.penguji.p2 === currentUser.nama || s.penguji.p3 === currentUser.nama
                );
            } else if(currentUser?.role === 'mahasiswa') {
                data = dbSidang.filter(s => s.npm === currentUser.username);
            }

            data.forEach(s => {
                if(currentUser?.role === 'dosen') {
                    let myRoles = [];
                    if(s.pem1 === currentUser.nama) myRoles.push({k:'pem1', l:'Pembimbing 1'});
                    if(s.pem2 === currentUser.nama) myRoles.push({k:'pem2', l:'Pembimbing 2'});
                    if(s.penguji.p1 === currentUser.nama) myRoles.push({k:'p1', l:'Ketua Penguji'});
                    if(s.penguji.p2 === currentUser.nama) myRoles.push({k:'p2', l:'Penguji 2'});
                    if(s.penguji.p3 === currentUser.nama) myRoles.push({k:'p3', l:'Penguji 3'});

                    let rolesDetail = myRoles.map(r => {
                        let skor = s.nilai[r.k] || 0;
                        return `<div style="margin-bottom:3px;"><b>${r.l}:</b> ${skor} (${getNilaiHuruf(skor)})</div>`;
                    }).join('');

                    let btns = myRoles.map(r => `
                        <button class="btn-action btn-edit" style="width:100%; margin-bottom:5px;" onclick="openNilaiModal(${s.id}, '${r.k}', '${r.l}')">
                            <i class="fas fa-edit"></i> Input ${r.l}
                        </button>`).join('');

                    body.innerHTML += `
                        <tr>
                            <td><b>${s.nama}</b><br><small>${s.npm}</small></td>
                            <td>${s.jadwal}</td>
                            <td>${rolesDetail}</td>
                            <td>${s.status !== 'Pending' ? btns : '<small>Menunggu Jadwal</small>'}</td>
                            <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                        </tr>
                    `;
                } else {
                    let nContent = '';
                    if(currentUser?.role === 'mahasiswa') {
                        if(s.status === 'Done') {
                            const totalNilai = (s.nilai.pem1 || 0) + (s.nilai.pem2 || 0) + (s.nilai.p1 || 0) + (s.nilai.p2 || 0) + (s.nilai.p3 || 0);
                            const avg = (totalNilai / 5).toFixed(2);

                            nContent = `
                                <table class="sub-table">
                                    <tr style="background:#f8fafc;"><td colspan="2"><b>Nilai Bimbingan</b></td></tr>
                                    <tr><td>Bimbingan 1 (${s.pem1})</td><td><b>${s.nilai.pem1 || 0}</b></td></tr>
                                    <tr><td>Bimbingan 2 (${s.pem2})</td><td><b>${s.nilai.pem2 || 0}</b></td></tr>
                                    <tr style="background:#f8fafc;"><td colspan="2"><b>Nilai Sidang</b></td></tr>
                                    <tr><td>Ketua Penguji</td><td><b>${s.nilai.p1 || 0}</b></td></tr>
                                    <tr><td>Anggota 1</td><td><b>${s.nilai.p2 || 0}</b></td></tr>
                                    <tr><td>Anggota 2</td><td><b>${s.nilai.p3 || 0}</b></td></tr>
                                    <tr style="background:#ecfdf5; border-top: 2px solid #059669;">
                                        <td><b>RATA-RATA AKHIR</b></td>
                                        <td><b style="color:var(--primary);">${avg} (${getNilaiHuruf(avg)})</b></td>
                                    </tr>
                                </table>
                                <button class="btn-download" onclick='unduhHasilSidang(${JSON.stringify(s)})'>
                                    <i class="fas fa-file-pdf"></i> Unduh Hasil Sidang
                                </button>`;
                        } else {
                            nContent = `<span style="font-style:italic; color:#999;">Nilai sedang diproses...</span>`;
                        }
                    } else {
                        nContent = `
                            <table class="sub-table">
                                <tr><td>Pem 1: ${s.pem1}</td><td><b>${s.nilai.pem1 || 0}</b></td></tr>
                                <tr><td>Pem 2: ${s.pem2}</td><td><b>${s.nilai.pem2 || 0}</b></td></tr>
                                <tr><td>P1: ${s.penguji.p1}</td><td><b>${s.nilai.p1 || 0}</b></td></tr>
                                <tr><td>P2: ${s.penguji.p2}</td><td><b>${s.nilai.p2 || 0}</b></td></tr>
                                <tr><td>P3: ${s.penguji.p3}</td><td><b>${s.nilai.p3 || 0}</b></td></tr>
                            </table>`;
                    }

                    body.innerHTML += `
                        <tr>
                            <td><b>${s.nama}</b><br><small>${s.npm}</small><br><small><i>${s.judul}</i></small></td>
                            <td>${s.jadwal}</td>
                            <td>${nContent}</td>
                            <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                        </tr>
                    `;
                }
            });
        }

        // FUNGSI UNDUH PDF DENGAN PENGECEKAN PEMUATAN GAMBAR
        async function unduhHasilSidang(data) {
            const { jsPDF } = window.jspdf;
            const totalNilai = (data.nilai.pem1 || 0) + (data.nilai.pem2 || 0) + (data.nilai.p1 || 0) + (data.nilai.p2 || 0) + (data.nilai.p3 || 0);
            const avg = (totalNilai / 5).toFixed(2);
            const grade = getNilaiHuruf(avg);

            document.getElementById('pdf-nama-mhs').innerText = data.nama.toUpperCase();
            document.getElementById('pdf-grade').innerText = grade;
            document.getElementById('pdf-skor').innerText = avg;
            
            const skrg = new Date();
            const bulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('pdf-tgl-skrg').innerText = `${skrg.getDate()} ${bulan[skrg.getMonth()]} ${skrg.getFullYear()}`;

            const element = document.getElementById('pdf-template');
            element.style.visibility = 'visible'; // Sementara dibuat terlihat untuk html2canvas

            // Tunggu gambar Kop Surat dimuat
            const kopImg = document.getElementById('img-kop');
            const waitForImage = () => {
                if (kopImg.complete) return Promise.resolve();
                return new Promise(resolve => { kopImg.onload = resolve; kopImg.onerror = resolve; });
            };

            await waitForImage();

            html2canvas(element, { 
                scale: 4, 
                useCORS: true, 
                logging: false,
                allowTaint: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Hasil_Sidang_${data.npm}.pdf`);
                element.style.visibility = 'hidden';
            }).catch(err => {
                console.error("PDF Error:", err);
                element.style.visibility = 'hidden';
            });
        }

        document.getElementById('formDaftar').onsubmit = function(e) {
            e.preventDefault();
            const id = Date.now();
            db.ref('sidang/' + id).set({
                id: id, nama: currentUser.nama, npm: currentUser.username, judul: document.getElementById('judul').value,
                pem1: document.getElementById('pembimbing1').value, pem2: document.getElementById('pembimbing2').value,
                jadwal: '-', status: 'Pending', penguji: {p1:'-', p2:'-', p3:'-'},
                nilai: {pem1:0, pem2:0, p1:0, p2:0, p3:0}, revisi: {pem1:'', pem2:'', p1:'', p2:'', p3:''}
            });
            alert('Pendaftaran Berhasil!');
            showSection('jadwal');
        };

        function renderAdmin() {
            const body = document.getElementById('bodyAdmin');
            body.innerHTML = dbSidang.map(s => `
                <tr>
                    <td><b>${s.nama}</b><br>${s.npm}</td><td>${s.judul}</td><td>${s.jadwal}</td>
                    <td>
                        <button class="btn-action btn-edit" onclick="openJadwalModal(${s.id})"><i class="fas fa-clock"></i></button>
                        <button class="btn-action btn-delete" onclick="hapusSidang(${s.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openJadwalModal(id) {
            document.getElementById('edit-id').value = id;
            document.getElementById('modalJadwal').style.display = 'flex';
        }

        function saveJadwalCloud() {
            const id = document.getElementById('edit-id').value;
            db.ref('sidang/' + id).update({
                jadwal: `${document.getElementById('set-tgl').value} Pukul ${document.getElementById('set-jam').value} WIB`,
                status: 'Scheduled',
                penguji: { p1: document.getElementById('set-p1').value, p2: document.getElementById('set-p2').value, p3: document.getElementById('set-p3').value }
            });
            closeModal();
        }

        function openNilaiModal(id, role, label) {
            const s = dbSidang.find(x => x.id == id);
            document.getElementById('n-id').value = id;
            document.getElementById('n-role').value = role;
            document.getElementById('n-title').innerText = `Input Nilai: ${label} untuk ${s.nama}`;
            document.getElementById('n-skor').value = s.nilai[role] || '';
            document.getElementById('n-revisi').value = s.revisi[role] || '';
            document.getElementById('modalNilai').style.display = 'flex';
        }

        function saveNilaiCloud() {
            const id = document.getElementById('n-id').value;
            const role = document.getElementById('n-role').value;
            const skor = parseFloat(document.getElementById('n-skor').value) || 0;
            
            db.ref(`sidang/${id}/nilai/${role}`).set(skor);
            db.ref(`sidang/${id}/revisi/${role}`).set(document.getElementById('n-revisi').value);
            
            const s = dbSidang.find(x => x.id == id);
            const n = {...s.nilai, [role]: skor};
            if(n.pem1 > 0 && n.pem2 > 0 && n.p1 > 0 && n.p2 > 0 && n.p3 > 0) {
                db.ref(`sidang/${id}/status`).set('Done');
            }
            closeModal();
        }

        function addDosen(e) {
            e.preventDefault();
            const u = document.getElementById('d-user').value;
            db.ref('dosen/' + u).set({
                nama: document.getElementById('d-nama').value,
                username: u, password: document.getElementById('d-pass').value
            });
            e.target.reset();
        }

        function renderDosenList() {
            const body = document.getElementById('bodyDosen');
            body.innerHTML = dbDosen.map(d => `
                <tr><td>${d.nama}</td><td>${d.username}</td><td><button class="btn-action btn-delete" onclick="db.ref('dosen/${d.username}').remove()">Hapus</button></td></tr>
            `).join('');
        }

        function populateDosenSelects() {
            let opts = '<option value="-">-- Pilih Dosen --</option>' + dbDosen.map(d => `<option value="${d.nama}">${d.nama}</option>`).join('');
            ['pembimbing1','pembimbing2','set-p1','set-p2','set-p3'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).innerHTML = opts;
            });
        }

        function hapusSidang(id) { if(confirm('Hapus?')) db.ref('sidang/'+id).remove(); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function resetSemuaData() {
            const code = Math.random().toString(36).substring(7).toUpperCase();
            if(prompt(`Ketik "${code}" untuk reset database:`) === code) db.ref('sidang').remove();
        }

        if(currentUser) initApp();
    </script>
</body>
</html>
